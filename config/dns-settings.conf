# Pidanos DNS-specific Settings
# =============================
# Advanced DNS configuration options

# DNS Resolution Settings
resolution:
  # Parallel queries to upstream servers
  parallel_queries: true
  
  # Query strategy: first, random, round_robin, fastest
  strategy: "fastest"
  
  # Fallback to secondary DNS on timeout
  use_fallback: true
  
  # EDNS Client Subnet (ECS)
  ecs:
    enabled: false
    ipv4_mask: 24
    ipv6_mask: 56
  
  # Query validation
  validation:
    # Reject non-standard queries
    strict: false
    # Check query name validity
    validate_names: true
    # Maximum query name length
    max_name_length: 255

# DNS Protocol Settings
protocol:
  # Supported query types
  allowed_types:
    - A
    - AAAA
    - CNAME
    - MX
    - TXT
    - NS
    - SOA
    - SRV
    - PTR
    - CAA
    - DNSKEY
    - DS
    - NSEC
    - NSEC3
    - RRSIG
    
  # Blocked query types
  blocked_types:
    - ANY
    - AXFR
    - IXFR
    
  # Response settings
  response:
    # Include authority section
    include_authority: false
    # Include additional section
    include_additional: true
    # Compress responses
    compression: true
    # Maximum response size
    max_size: 4096

# Upstream DNS Configuration
upstream:
  # Health checking
  health_check:
    enabled: true
    interval: 300  # 5 minutes
    timeout: 2
    failures_threshold: 3
    
  # Load balancing
  load_balancing:
    method: "weighted"  # weighted, least_connections, round_robin
    weights:
      "1.1.1.1": 100
      "8.8.8.8": 80
      "9.9.9.9": 60
      
  # Per-upstream settings
  servers:
    cloudflare:
      ips:
        - "1.1.1.1"
        - "1.0.0.1"
      port: 53
      tcp: false
      tls: false
      timeout: 2
      
    cloudflare_family:
      ips:
        - "1.1.1.3"  # Blocks malware and adult content
        - "1.0.0.3"
      port: 53
      tags: ["family", "safe"]
      
    google:
      ips:
        - "8.8.8.8"
        - "8.8.4.4"
      port: 53
      tcp: false
      
    quad9:
      ips:
        - "9.9.9.9"
        - "149.112.112.112"
      port: 53
      features: ["malware_blocking", "dnssec"]
      
    # DNS-over-TLS servers
    cloudflare_dot:
      hostname: "cloudflare-dns.com"
      ips:
        - "1.1.1.1"
        - "1.0.0.1"
      port: 853
      tls: true
      verify_hostname: true
      
    # DNS-over-HTTPS servers
    cloudflare_doh:
      url: "https://cloudflare-dns.com/dns-query"
      method: "POST"
      headers:
        Accept: "application/dns-message"

# Special Domains Configuration
special_domains:
  # Local domain handling
  local:
    # Domains that should never be forwarded
    never_forward:
      - "local"
      - "localhost"
      - "home"
      - "lan"
      - "corp"
      - "private"
      
    # Reverse DNS for private IPs
    private_reverse:
      "10.in-addr.arpa": "192.168.1.1"
      "168.192.in-addr.arpa": "192.168.1.1"
      "16-31.172.in-addr.arpa": "192.168.1.1"
      
  # Split DNS / Conditional forwarding
  conditional:
    - domain: "company.local"
      servers:
        - "192.168.1.10"
        - "192.168.1.11"
      search_domains:
        - "company.local"
        - "corp.company.local"
        
    - domain: "home.arpa"
      servers:
        - "192.168.1.1"

# DNS Security Settings
security:
  # DNSSEC validation
  dnssec:
    enabled: true
    trust_anchors_file: "/etc/pidanos/trust-anchors.xml"
    check_unsigned: true
    
  # DNS rebinding protection
  rebinding_protection:
    enabled: true
    allowed_ranges:
      - "192.168.0.0/16"
      - "10.0.0.0/8"
      - "172.16.0.0/12"
      
  # Query rate limiting per client
  rate_limiting:
    enabled: true
    requests_per_second: 20
    burst: 40
    cache_size: 10000
    ipv4_prefix_length: 24
    ipv6_prefix_length: 56
    
  # Bogus IP rejection
  bogus_nxdomain:
    enabled: true
    addresses:
      - "0.0.0.0"
      - "127.0.0.1"
      - "255.255.255.255"
      - "::"
      - "::1"

# Caching Behavior
caching:
  # Cache poisoning protection
  protection:
    enabled: true
    # Don't cache responses from non-requested servers
    check_source: true
    # Validate response IDs
    check_id: true
    
  # Negative caching (NXDOMAIN)
  negative:
    enabled: true
    ttl: 3600
    
  # Cache prefetching
  prefetch:
    enabled: true
    # Prefetch when TTL% remaining
    threshold: 10
    # Popular domains to always prefetch
    domains:
      - "google.com"
      - "youtube.com"
      - "facebook.com"
      - "amazon.com"
      - "reddit.com"
      
  # Cache persistence
  persistence:
    enabled: true
    save_interval: 3600
    file: "/var/lib/pidanos/cache.db"

# Advanced Features
advanced:
  # EDNS options
  edns:
    buffer_size: 1232
    do_bit: true  # DNSSEC OK
    version: 0
    
  # TCP fallback
  tcp_fallback:
    enabled: true
    # Switch to TCP if response is truncated
    on_truncation: true
    # Use TCP for queries larger than
    query_size_threshold: 512
    
  # Query rewriting
  rewrite:
    enabled: false
    rules:
      # - from: "old.example.com"
      #   to: "new.example.com"
      #   type: "CNAME"
      
  # Response policy zones (RPZ)
  rpz:
    enabled: false
    zones:
      # - "rpz.example.com"
    
  # DNS64 (IPv6 transition)
  dns64:
    enabled: false
    prefix: "64:ff9b::/96"
    
# Logging Configuration
logging:
  # Query logging
  queries:
    enabled: true
    # Log all queries or only blocked
    log_all: false
    # Include client IP
    log_client: true
    # Include response
    log_response: false
    # Anonymize IPs
    anonymize: false
    anonymize_bits: 8
    
  # Upstream logging
  upstream:
    enabled: true
    # Log failures only
    failures_only: false
    
  # Cache logging
  cache:
    enabled: false
    # Log hits and misses
    log_hits: true
    log_misses: true